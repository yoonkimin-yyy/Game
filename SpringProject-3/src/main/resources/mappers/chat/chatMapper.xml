<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
  							"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace=kr.co.green.chatmapper.ChatMapper>

<resultMap id="chatResultMap" type="kr.co.green.chatmessage.dto.ChatMessageDTO">

		<id property="messageId" column="message_id"/>
        <result property="roomId" column="room_id"/>
        <result property="sender" column="send_user_id"/>
        <result property="receiver" column="receiver"/>
        <result property="content" column="room_detail"/>
        <result property="timeStamp" column="send_time"/>
        
</resultMap>

 <!-- 메시지 저장 -->
    <insert id="saveMessage" useGeneratedKeys="true" keyProperty="messageId">
        INSERT INTO MESSENGER_detail (message_id, room_id, room_detail, send_time, send_user_id, message_type)
        VALUES (messenger_seq.NEXTVAL, #{roomId}, #{content}, CURRENT_TIMESTAMP, #{sender}, 'TEXT')
    </insert>

    <!-- 특정 사용자의 채팅 내역 조회 -->
    <select id="getMessageByUser" resultType="kr.co.green.chatmessage.dto.ChatMessageDTO">
        SELECT 
            md.message_id AS messageId,
            md.room_id AS roomId,
            md.room_detail AS content,
            md.send_time AS timeStamp,
            md.send_user_id AS sender
        FROM MESSENGER_detail md
        JOIN room_user ru ON md.room_id = ru.room_id
        WHERE ru.user_id = #{user}
        ORDER BY md.send_time ASC
    </select>

    <!-- 특정 채팅방의 모든 메시지 조회 -->
    <select id="getMessageByRoomId" resultType="kr.co.green.chatmessage.dto.ChatMessageDTO">
        SELECT 
            message_id AS messageId,
            room_id AS roomId,
            room_detail AS content,
            send_time AS timeStamp,
            send_user_id AS sender
        FROM MESSENGER_detail
        WHERE room_id = #{roomId}
        ORDER BY send_time ASC
    </select>









</mapper>